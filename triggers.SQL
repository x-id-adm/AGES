-- #################################################################################################
-- =================================================================================================
-- # GATILHOS (TRIGGERS)
-- =================================================================================================
-- Esta seÃ§Ã£o contÃ©m todos os triggers do sistema, organizados por tabela alvo:
--
-- 2.1 TRIGGERS DE SINCRONIZAÃ‡ÃƒO
--     â””â”€ trig_sync_owner_to_cell ............. [3a_customer_root_record] â†’ Sincroniza whatsapp
--
-- 2.2 TRIGGERS DE GERAÃ‡ÃƒO DE IDS
--     â””â”€ trg_generate_client_id .............. [3a_customer_root_record] â†’ Gera client_id
--     â””â”€ trg_generate_service_id ............. [4a_customer_service_history] â†’ Gera service_id
--
-- 2.3 TRIGGERS AUTOMÃTICOS (APLICADOS DINAMICAMENTE)
--     â””â”€ trigger_update_timestamp ............ [TODAS COM updated_at] â†’ Atualiza timestamp
--
-- 2.4 TRIGGERS DE MARCAÃ‡ÃƒO PRIMÃRIA
--     â””â”€ trg_first_cell_phone_is_primary ..... [3b_cell_phone_linked_service_sheet] â†’ Primeiro = primÃ¡rio
--     â””â”€ trg_first_email_is_primary .......... [3e_email] â†’ Primeiro = primÃ¡rio
--     â””â”€ trg_first_landline_is_primary ....... [3f_landline_phone] â†’ Primeiro = primÃ¡rio
--
-- 2.5 TRIGGERS DE AUTOMAÃ‡ÃƒO DE MENSAGENS
--     â””â”€ trg_auto_populate_message ........... [2b_conversation_messages] â†’ Popula campos automÃ¡ticos
--
-- 2.6 TRIGGERS DE VALIDAÃ‡ÃƒO DE FORMULÃRIO COMPLETO
--     â””â”€ trg_check_form_complete_3a .......... [3a_customer_root_record] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3b .......... [3b_cell_phone_linked_service_sheet] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3c .......... [3c_gender] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3d .......... [3d_birth_date] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3e .......... [3e_email] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3f .......... [3f_landline_phone] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3g .......... [3g_cpf] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3h .......... [3h_rg] â†’ Valida completude
--     â””â”€ trg_check_form_complete_3i .......... [3i_endereco_br] â†’ Valida completude
--
-- 2.7 TRIGGERS DE CONTADORES DE STATUS DE ATENDIMENTOS
--     â””â”€ trg_update_appointment_status_counter [4a_customer_service_history] â†’ Atualiza contadores de status
-- =================================================================================================


-- -------------------------------------------------------------------------------------------------
-- 2.1 TRIGGERS DE SINCRONIZAÃ‡ÃƒO
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trig_sync_owner_to_cell                                                            â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 3a_customer_root_record                                                        â•‘
-- â•‘ EVENTO: AFTER INSERT OR UPDATE                                                              â•‘
-- â•‘ FUNÃ‡ÃƒO: func_sync_owner_to_cell_sheet()                                                     â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   Quando um registro Ã© criado/atualizado em 3a_customer_root_record:                        â•‘
-- â•‘   â†’ Busca o wallet_id correspondente ao whatsapp_owner                                      â•‘
-- â•‘   â†’ Cria/atualiza registro na 3b_cell_phone_linked_service_sheet                            â•‘
-- â•‘   â†’ Define o telefone como primÃ¡rio, verificado e WhatsApp                                  â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trig_sync_owner_to_cell ON "3a_customer_root_record";

CREATE TRIGGER trig_sync_owner_to_cell
    AFTER INSERT OR UPDATE ON "3a_customer_root_record"
    FOR EACH ROW
    EXECUTE FUNCTION func_sync_owner_to_cell_sheet();


-- -------------------------------------------------------------------------------------------------
-- 2.2 TRIGGERS DE GERAÃ‡ÃƒO DE IDS
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_generate_client_id                                                             â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 3a_customer_root_record                                                        â•‘
-- â•‘ EVENTO: BEFORE INSERT                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: func_generate_friendly_client_id()                                                  â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   Antes de inserir um novo cliente:                                                         â•‘
-- â•‘   â†’ Incrementa o contador client_count da inbox                                             â•‘
-- â•‘   â†’ Atribui client_id = "CT" + nÃºmero (ex: CT1, CT2, CT3...)                                â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_generate_client_id ON "3a_customer_root_record";

CREATE TRIGGER trg_generate_client_id
    BEFORE INSERT ON "3a_customer_root_record"
    FOR EACH ROW
    EXECUTE FUNCTION func_generate_friendly_client_id();


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_generate_service_id                                                            â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 4a_customer_service_history                                                    â•‘
-- â•‘ EVENTO: BEFORE INSERT                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: func_generate_friendly_service_id()                                                 â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   Antes de inserir um novo atendimento:                                                     â•‘
-- â•‘   â†’ Incrementa o contador atendimento_count da inbox                                        â•‘
-- â•‘   â†’ Atribui service_id = "AT" + nÃºmero (ex: AT1, AT2, AT3...)                               â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_generate_service_id ON "4a_customer_service_history";

CREATE TRIGGER trg_generate_service_id
    BEFORE INSERT ON "4a_customer_service_history"
    FOR EACH ROW
    EXECUTE FUNCTION func_generate_friendly_service_id();


-- -------------------------------------------------------------------------------------------------
-- 2.3 TRIGGERS AUTOMÃTICOS (APLICAÃ‡ÃƒO DINÃ‚MICA)
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trigger_update_timestamp (APLICADO DINAMICAMENTE)                                  â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELAS ALVO: Todas que possuem coluna 'updated_at'                                         â•‘
-- â•‘ EVENTO: BEFORE UPDATE                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: update_updated_at_column()                                                          â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   O bloco abaixo descobre automaticamente todas as tabelas do schema 'public'               â•‘
-- â•‘   que possuem a coluna 'updated_at' e aplica o trigger em cada uma delas.                   â•‘
-- â•‘                                                                                             â•‘
-- â•‘ AÃ‡ÃƒO:                                                                                       â•‘
-- â•‘   â†’ A cada UPDATE, define updated_at = NOW() automaticamente                                â•‘
-- â•‘                                                                                             â•‘
-- â•‘ TABELAS AFETADAS (descobertas dinamicamente):                                               â•‘
-- â•‘   â€¢ 0a_inbox_whatsapp                                                                       â•‘
-- â•‘   â€¢ 1a_whatsapp_user_contact                                                                â•‘
-- â•‘   â€¢ 3a_customer_root_record                                                                 â•‘
-- â•‘   â€¢ 3b_cell_phone_linked_service_sheet                                                      â•‘
-- â•‘   â€¢ 4a_customer_service_history                                                             â•‘
-- â•‘   â€¢ ... (e todas as outras com updated_at)                                                  â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DO $
DECLARE
    t text;
BEGIN
    FOR t IN 
        SELECT table_name 
        FROM information_schema.columns 
        WHERE column_name = 'updated_at' 
          AND table_schema = 'public'
    LOOP
        EXECUTE format('
            DROP TRIGGER IF EXISTS trigger_update_timestamp ON %I;
            CREATE TRIGGER trigger_update_timestamp
            BEFORE UPDATE ON %I
            FOR EACH ROW
            EXECUTE FUNCTION update_updated_at_column();
        ', t, t);
    END LOOP;
END$;


-- -------------------------------------------------------------------------------------------------
-- 2.4 TRIGGERS DE MARCAÃ‡ÃƒO PRIMÃRIA
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_first_cell_phone_is_primary                                                    â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 3b_cell_phone_linked_service_sheet                                             â•‘
-- â•‘ EVENTO: BEFORE INSERT                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: func_ensure_first_is_primary()                                                      â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   O primeiro telefone celular adicionado a uma ficha Ã© automaticamente marcado como         â•‘
-- â•‘   primÃ¡rio (is_primary = TRUE). Telefones adicionais ficam como FALSE por padrÃ£o.           â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_first_cell_phone_is_primary ON "3b_cell_phone_linked_service_sheet";

CREATE TRIGGER trg_first_cell_phone_is_primary
    BEFORE INSERT ON "3b_cell_phone_linked_service_sheet"
    FOR EACH ROW
    EXECUTE FUNCTION func_ensure_first_is_primary();


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_first_email_is_primary                                                         â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 3e_email                                                                       â•‘
-- â•‘ EVENTO: BEFORE INSERT                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: func_ensure_first_is_primary()                                                      â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   O primeiro e-mail adicionado a uma ficha Ã© automaticamente marcado como primÃ¡rio          â•‘
-- â•‘   (is_primary = TRUE). E-mails adicionais ficam como FALSE por padrÃ£o.                      â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_first_email_is_primary ON "3e_email";

CREATE TRIGGER trg_first_email_is_primary
    BEFORE INSERT ON "3e_email"
    FOR EACH ROW
    EXECUTE FUNCTION func_ensure_first_is_primary();


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_first_landline_is_primary                                                      â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 3f_landline_phone                                                              â•‘
-- â•‘ EVENTO: BEFORE INSERT                                                                       â•‘
-- â•‘ FUNÃ‡ÃƒO: func_ensure_first_is_primary()                                                      â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   O primeiro telefone fixo adicionado a uma ficha Ã© automaticamente marcado como primÃ¡rio   â•‘
-- â•‘   (is_primary = TRUE). Telefones fixos adicionais ficam como FALSE por padrÃ£o.              â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_first_landline_is_primary ON "3f_landline_phone";

CREATE TRIGGER trg_first_landline_is_primary
    BEFORE INSERT ON "3f_landline_phone"
    FOR EACH ROW
    EXECUTE FUNCTION func_ensure_first_is_primary();


-- -------------------------------------------------------------------------------------------------
-- 2.5 TRIGGERS DE AUTOMAÃ‡ÃƒO DE MENSAGENS
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_auto_populate_message                                                          â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 2b_conversation_messages                                                       â•‘
-- â•‘ EVENTO: BEFORE INSERT OR UPDATE                                                             â•‘
-- â•‘ FUNÃ‡ÃƒO: func_auto_populate_message_fields()                                                 â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   Antes de inserir ou atualizar uma mensagem:                                               â•‘
-- â•‘   â†’ Se sender_type Ã© interno (ai_agent, human_agent, system) E source_message_id vazio      â•‘
-- â•‘     â€¢ Gera ULID automaticamente para rastreamento                                           â•‘
-- â•‘   â†’ Se message_content nÃ£o Ã© vazio                                                          â•‘
-- â•‘     â€¢ Converte para tsvector portuguÃªs para busca full-text otimizada                       â•‘
-- â•‘                                                                                             â•‘
-- â•‘ EXEMPLOS:                                                                                   â•‘
-- â•‘   INSERT sender_type='contact', source_message_id='wamid.xyz'                               â•‘
-- â•‘   â†’ MantÃ©m o ID externo do WhatsApp                                                         â•‘
-- â•‘                                                                                             â•‘
-- â•‘   INSERT sender_type='ai_agent', source_message_id=NULL                                     â•‘
-- â•‘   â†’ Gera: '01HW5Z8K7F9G2M3N4P5Q6R7S8T' (ULID)                                               â•‘
-- â•‘                                                                                             â•‘
-- â•‘   INSERT message_content='OlÃ¡, como posso ajudar?'                                          â•‘
-- â•‘   â†’ Cria tsvector: 'ajud':5 'olÃ¡':1 'pod':3                                                 â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_auto_populate_message ON "2b_conversation_messages";

CREATE TRIGGER trg_auto_populate_message
    BEFORE INSERT OR UPDATE ON "2b_conversation_messages"
    FOR EACH ROW
    EXECUTE FUNCTION func_auto_populate_message_fields();


-- -------------------------------------------------------------------------------------------------
-- 2.6 TRIGGERS DE VALIDAÃ‡ÃƒO DE FORMULÃRIO COMPLETO
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGERS: trg_check_form_complete_*                                                         â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELAS ALVO: Todas as tabelas do NÃVEL 3 (3a atÃ© 3i)                                      â•‘
-- â•‘ EVENTO: AFTER INSERT OR UPDATE                                                              â•‘
-- â•‘ FUNÃ‡ÃƒO: func_update_form_counter()                                                          â•‘
-- â•‘                                                                                             â•‘
-- â•‘ PROPÃ“SITO:                                                                                  â•‘
-- â•‘   Monitora mudanÃ§as em qualquer campo da ficha de cliente e automaticamente:                â•‘
-- â•‘   1. Verifica se a ficha estÃ¡ completa baseado em required_data_form da inbox               â•‘
-- â•‘   2. Atualiza o campo is_form_complete na tabela 3a_customer_root_record                    â•‘
-- â•‘   3. Incrementa/decrementa o contador form_count em 0b_inbox_counters                       â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   Quando qualquer dado da ficha Ã© inserido ou atualizado:                                   â•‘
-- â•‘   â†’ Trigger dispara APÃ“S a operaÃ§Ã£o (garantindo dados consistentes)                         â•‘
-- â•‘   â†’ FunÃ§Ã£o verifica completude baseada nas regras JSON da inbox                             â•‘
-- â•‘   â†’ Se mudou de estado (incompletoâ†’completo ou vice-versa), atualiza contador               â•‘
-- â•‘                                                                                             â•‘
-- â•‘ EXEMPLO DE FLUXO:                                                                           â•‘
-- â•‘   1. Inbox configurada com: {"treatment_name": {"required": true}, "cpf": {"required": true}}â”‚
-- â•‘   2. INSERT em 3a_customer_root_record com treatment_name                                   â•‘
-- â•‘      â†’ Trigger dispara â†’ Ficha incompleta (falta CPF) â†’ form_count nÃ£o muda                 â•‘
-- â•‘   3. INSERT em 3g_cpf com CPF do cliente                                                    â•‘
-- â•‘      â†’ Trigger dispara â†’ Ficha completa! â†’ form_count += 1 ğŸ‰                                â•‘
-- â•‘                                                                                             â•‘
-- â•‘ TABELAS MONITORADAS:                                                                        â•‘
-- â•‘   â€¢ 3a_customer_root_record ......... Campos: treatment_name, legal_name_complete, etc.     â•‘
-- â•‘   â€¢ 3b_cell_phone_linked_service .... Campo: cell_phone                                     â•‘
-- â•‘   â€¢ 3c_gender ....................... Campo: gender                                         â•‘
-- â•‘   â€¢ 3d_birth_date ................... Campo: birth_date                                     â•‘
-- â•‘   â€¢ 3e_email ........................ Campo: email                                          â•‘
-- â•‘   â€¢ 3f_landline_phone ............... Campo: phone_number                                   â•‘
-- â•‘   â€¢ 3g_cpf .......................... Campo: cpf                                            â•‘
-- â•‘   â€¢ 3h_rg ........................... Campo: rg_numero                                      â•‘
-- â•‘   â€¢ 3i_endereco_br .................. Campos: logradouro, cidade                            â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Tabela 3a: Raiz da ficha
DROP TRIGGER IF EXISTS trg_check_form_complete_3a ON "3a_customer_root_record";

CREATE TRIGGER trg_check_form_complete_3a
    AFTER INSERT OR UPDATE ON "3a_customer_root_record"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3b: Telefones celulares
DROP TRIGGER IF EXISTS trg_check_form_complete_3b ON "3b_cell_phone_linked_service_sheet";

CREATE TRIGGER trg_check_form_complete_3b
    AFTER INSERT OR UPDATE ON "3b_cell_phone_linked_service_sheet"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3c: GÃªnero
DROP TRIGGER IF EXISTS trg_check_form_complete_3c ON "3c_gender";

CREATE TRIGGER trg_check_form_complete_3c
    AFTER INSERT OR UPDATE ON "3c_gender"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3d: Data de nascimento
DROP TRIGGER IF EXISTS trg_check_form_complete_3d ON "3d_birth_date";

CREATE TRIGGER trg_check_form_complete_3d
    AFTER INSERT OR UPDATE ON "3d_birth_date"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3e: E-mails
DROP TRIGGER IF EXISTS trg_check_form_complete_3e ON "3e_email";

CREATE TRIGGER trg_check_form_complete_3e
    AFTER INSERT OR UPDATE ON "3e_email"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3f: Telefones fixos
DROP TRIGGER IF EXISTS trg_check_form_complete_3f ON "3f_landline_phone";

CREATE TRIGGER trg_check_form_complete_3f
    AFTER INSERT OR UPDATE ON "3f_landline_phone"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3g: CPF
DROP TRIGGER IF EXISTS trg_check_form_complete_3g ON "3g_cpf";

CREATE TRIGGER trg_check_form_complete_3g
    AFTER INSERT OR UPDATE ON "3g_cpf"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3h: RG
DROP TRIGGER IF EXISTS trg_check_form_complete_3h ON "3h_rg";

CREATE TRIGGER trg_check_form_complete_3h
    AFTER INSERT OR UPDATE ON "3h_rg"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- Tabela 3i: EndereÃ§o
DROP TRIGGER IF EXISTS trg_check_form_complete_3i ON "3i_endereco_br";

CREATE TRIGGER trg_check_form_complete_3i
    AFTER INSERT OR UPDATE ON "3i_endereco_br"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_form_counter();


-- -------------------------------------------------------------------------------------------------
-- 2.7 TRIGGERS DE CONTADORES DE STATUS DE ATENDIMENTOS
-- -------------------------------------------------------------------------------------------------

-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_set_status_timestamp                                                           â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 4a_customer_service_history                                                    â•‘
-- â•‘ EVENTO: BEFORE INSERT OR UPDATE                                                             â•‘
-- â•‘ FUNÃ‡ÃƒO: func_set_status_timestamp()                                                         â•‘
-- â•‘                                                                                             â•‘
-- â•‘ PROPÃ“SITO:                                                                                  â•‘
-- â•‘   Preenche automaticamente os campos de timestamp (scheduled_at, confirmed_at, etc.)        â•‘
-- â•‘   quando um agendamento Ã© criado ou tem seu status alterado.                                â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   â€¢ INSERT: Define o timestamp do status inicial                                            â•‘
-- â•‘   â€¢ UPDATE: Define o timestamp do novo status (preserva os anteriores)                      â•‘
-- â•‘                                                                                             â•‘
-- â•‘ OBSERVAÃ‡ÃƒO:                                                                                 â•‘
-- â•‘   Este trigger executa ANTES (BEFORE) para modificar o registro antes de salvar.            â•‘
-- â•‘   Deve vir antes do trigger de contadores (que executa AFTER).                              â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_set_status_timestamp ON "4a_customer_service_history";

CREATE TRIGGER trg_set_status_timestamp
    BEFORE INSERT OR UPDATE ON "4a_customer_service_history"
    FOR EACH ROW
    EXECUTE FUNCTION func_set_status_timestamp();


-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
-- â•‘ TRIGGER: trg_update_appointment_status_counter                                              â•‘
-- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
-- â•‘ TABELA ALVO: 4a_customer_service_history                                                    â•‘
-- â•‘ EVENTO: AFTER INSERT OR UPDATE                                                              â•‘
-- â•‘ FUNÃ‡ÃƒO: func_update_appointment_status_counter()                                            â•‘
-- â•‘                                                                                             â•‘
-- â•‘ PROPÃ“SITO:                                                                                  â•‘
-- â•‘   Monitora mudanÃ§as na tabela de atendimentos e automaticamente atualiza os contadores      â•‘
-- â•‘   de status em 0b_inbox_counters quando:                                                    â•‘
-- â•‘   â€¢ Um novo atendimento Ã© criado (INSERT)                                                   â•‘
-- â•‘   â€¢ O status de um atendimento Ã© alterado (UPDATE)                                          â•‘
-- â•‘                                                                                             â•‘
-- â•‘ COMPORTAMENTO:                                                                              â•‘
-- â•‘   INSERT:                                                                                   â•‘
-- â•‘   â†’ Incrementa contador do status do novo atendimento                                       â•‘
-- â•‘                                                                                             â•‘
-- â•‘   UPDATE (quando service_status muda):                                                      â•‘
-- â•‘   â†’ Decrementa contador do status antigo                                                    â•‘
-- â•‘   â†’ Incrementa contador do novo status                                                      â•‘
-- â•‘                                                                                             â•‘
-- â•‘ CONTADORES ATUALIZADOS:                                                                     â•‘
-- â•‘   â€¢ scheduled_count ..... Atendimentos com status 'Scheduled'                               â•‘
-- â•‘   â€¢ confirmed_count ..... Atendimentos com status 'Confirmed'                               â•‘
-- â•‘   â€¢ completed_count ..... Atendimentos com status 'Completed'                               â•‘
-- â•‘   â€¢ cancelled_count ..... Atendimentos com status 'Cancelled'                               â•‘
-- â•‘   â€¢ rescheduled_count ... Atendimentos com status 'Rescheduled'                             â•‘
-- â•‘   â€¢ no_show_count ....... Atendimentos com status 'No_Show'                                 â•‘
-- â•‘                                                                                             â•‘
-- â•‘ EXEMPLO DE FLUXO:                                                                           â•‘
-- â•‘   1. INSERT atendimento com status 'Scheduled'                                              â•‘
-- â•‘      â†’ scheduled_count: 0 â†’ 1                                                               â•‘
-- â•‘                                                                                             â•‘
-- â•‘   2. UPDATE status: 'Scheduled' â†’ 'Confirmed'                                               â•‘
-- â•‘      â†’ scheduled_count: 1 â†’ 0                                                               â•‘
-- â•‘      â†’ confirmed_count: 0 â†’ 1                                                               â•‘
-- â•‘                                                                                             â•‘
-- â•‘   3. UPDATE status: 'Confirmed' â†’ 'Completed'                                               â•‘
-- â•‘      â†’ confirmed_count: 1 â†’ 0                                                               â•‘
-- â•‘      â†’ completed_count: 0 â†’ 1                                                               â•‘
-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DROP TRIGGER IF EXISTS trg_update_appointment_status_counter ON "4a_customer_service_history";

CREATE TRIGGER trg_update_appointment_status_counter
    AFTER INSERT OR UPDATE ON "4a_customer_service_history"
    FOR EACH ROW
    EXECUTE FUNCTION func_update_appointment_status_counter();


